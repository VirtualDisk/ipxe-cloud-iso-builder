#!/usr/bin/env bash
set -euo pipefail

mkdir -p /repo
cd /repo

git clone -b "${IPXE_VERSION:-master}" "https://github.com/ipxe/ipxe"

sed -ie 's/#undef    IMAGE_COMBOOT/#define    IMAGE_COMBOOT/' /repo/ipxe/src/config/general.h
sed -ie 's/#undef    DOWNLOAD_PROTO_HTTPS/#define    DOWNLOAD_PROTO_HTTPS/' /repo/ipxe/src/config/general.h
sed -ie 's/#undef    VLAN_CMD/#define    VLAN_CMD/' /repo/ipxe/src/config/general.h
sed -ie 's/#undef    NSLOOKUP_CMD/#define    NSLOOKUP_CMD/' /repo/ipxe/src/config/general.h
sed -ie 's/#undef    REBOOT_CMD/#define    REBOOT_CMD/' /repo/ipxe/src/config/general.h
sed -ie 's/#undef    POWEROFF_CMD/#define    POWEROFF_CMD/' /repo/ipxe/src/config/general.h
sed -ie 's/#undef    PING_CMD/#define    PING_CMD/' /repo/ipxe/src/config/general.h

cd ipxe/src && \
    make EMBED=/tmp/run.ipxe && \
    mv "bin/ipxe.iso" "/output/${IPXE_ISO_FILENAME:-ipxe}.iso"
